const W=100;const H=100;const CellSize=16;const PossibleSigns=["X","O","I","S","V","Z"];const ApiURLBase="/api/game_http_server/";const WhoPlaysURL=ApiURLBase+"who_plays";const JoinNewPlayerURL=ApiURLBase+"join";const LeaveGameURL=ApiURLBase+"leave";const GetFieldURL=ApiURLBase+"get_field";const MakeTurnURL=ApiURLBase+"make_turn";const ResetURL=ApiURLBase+"reset";const WhoWonURL=ApiURLBase+"who_won";$(document).ready(function(){var j=[];function e(){$.ajax({url:ResetURL,dataType:"text"}).done(function(l){if("ok"==l){$("#join-leave-button").removeAttr("in_game").text("Присоединиться");$("#player-name").val("");d();h()}})}function d(){var p=$("#field");p.html("");for(var q=0;q<H;++q){for(var l=0;l<W;++l){var o=CellSize*q;var n=CellSize*l;var m="<div class='cell' x='%1' y='%2' style='top:%3px;left:%4px;width:%5px;height:%6px'/>".replace("%1",l).replace("%2",q).replace("%3",o).replace("%4",n).replace("%5",CellSize).replace("%6",CellSize);p.append(m)}}$(".cell").click(function(){var r=$("#player-name").val();var t=$(this).attr("x");var s=$(this).attr("y");c(r,t,s)})}function b(l){if(l>=PossibleSigns.length){return""+(1+l-PossibleSigns.length)}else{return PossibleSigns[l]}}function a(l){for(var n=0;n<j.length;++n){var m=j[n];if(m.name==l){return m.symbol}}return""}function c(l,n,m){$.ajax({url:MakeTurnURL+"/"+l+"/"+n+"/"+m,dataType:"text"}).done(function(o){if("ok"==o){h()}else{if("not_your_turn"==o){alert("Сейчас не Ваш ход!")}else{if("game_over_you_win"==o){$("#game-over-dialog").text("Поздравляем! Вы выиграли!").dialog("open")}else{if("game_over"==o){alert("Игра окончена!")}}}}})}function h(){$.ajax({url:WhoPlaysURL,dataType:"json"}).done(function(r){var q=r.players;var p=r.whose_turn;var l="";j=[];for(var n=0;n<q.length;++n){var m=q[n];var o=b(n);j.push({symbol:o,name:m});if(m==p){l+="<span class='player-name active'>"+m+"("+o+")</span>"}else{l+="<span class='player-name inactive'>"+m+"("+o+")</span>"}}$("#who-plays").html(l);f()})}function f(){$.ajax({url:GetFieldURL,dataType:"json"}).done(function(p){var q=p;for(var m=0;m<q.length;++m){var n=q[m];var o=a(n.player);var l=".cell[x='"+n.x+"'][y='"+n.y+"']";$(l).text(o)}}).fail(function(m,l,o){var n=123})}function k(){var l=$("#player-name").val();if(l.length){$.ajax({url:JoinNewPlayerURL+"/"+l,dataType:"text"}).done(function(m){if("ok"==m){$("#join-leave-button").attr("in_game",true).text("Выйти");h()}else{if("player_exists"==m){alert("Игрок с таким именем уже в игре")}}})}}function i(){var l=$("#player-name").val();if(l.length){$.ajax({url:LeaveGameURL+"/"+l,dataType:"text"}).done(function(m){if("ok"==m){$("#join-leave-button").removeAttr("in_game").text("Присоединиться");h()}})}}$("#join-leave-button").button().click(function(){var l=$(this).attr("in_game");if(!l){k()}else{i()}});$("#reset-button").button().click(e);d();setInterval(h,1000);function g(){$.ajax({url:WhoWonURL,dataType:"json"}).done(function(m){var l=$("#player-name").val();if(m&&l!=m){$("#game-over-dialog").text("Вы проиграли! Победил "+m+".").dialog("open")}else{setTimeout(g,1000)}})}setTimeout(g,1000);$("#game-over-dialog").dialog({title:"Игра окончена",modal:true,autoOpen:false,buttons:[{text:"Начать заново",click:function(){e();$(this).dialog("close")}}]})});